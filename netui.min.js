(function(a){function c(a,b,c){return a<c?c:b<a?b:a}function d(){var a=[];for(var b=3;0<b;b--)a.push("0123456789abcdef"[Math.floor(Math.random()*16)]);return new Fashion.Color("#"+a.join(""))}function l(a){if(typeof a!="object"||a.constructor!=Object)return a;var b={};for(var c in a)c==="color"?b[c]=new Fashion.Color(a[c]):c==="fill"?b[c]=new Fashion.FloodFill(new Fashion.Color(a[c])):b[c]=l(a[c]);return b}var b={};classify.addDirective("accessor",function(a,b,c){return a.property["_"+b]=c,a.method[b]=function(a){return 0<arguments.length&&(this["_"+b]=a),this["_"+b]},a}),function(){function a(b,c){return b?b.prototype[c]||a(b.__proto__,c):null}classify.addDirective("after",function(b,c,d){var e=b.method[c]||a(b.parent,c);if(!e)throw Error('Declaration Error: after "'+c+'" is given but the target method not found.');return b.method[c]=function(){var a=e.apply(this,arguments);return d.apply(this,arguments),a},b}),classify.addDirective("before",function(b,c,d){var e=b.method[c]||a(b.parent,c);if(!e)throw Error('Declaration Error: before "'+c+'" is given but the target method not found.');return b.method[c]=function(){d.apply(this,arguments);var a=e.apply(this,arguments);return a},b})}();var e=classify("SortedList",{"static":{Tuple:classify("SortedList_Tuple",{parent:Array,method:{arrayize:function(){return Array.prototype.slice.call(this)}}})},property:{index:[],tbl:{}},method:{init:function(){},put:function(a,b){var c=this.index,d=this.tbl[a];if(d===void 0){this.tbl[a]=b;var f=0,g=c.length;while(f!=g){var h=f+g>>1;c[h]<a?f=h+1:g=h}c.splice(f,0,a)}else if(d!==b)if(d instanceof e.Tuple)d.push(b);else{var i=e.Tuple();i.push(d),i.push(b),this.tbl[a]=i}},get:function(a){var b=this.tbl[a];return b instanceof e.Tuple&&(b=b.arrayize()),b},replace:function(a,b,c,d){var e=this.remove(a,b,!0);(e||d)&&this.put(c,b)},remove:function(a,b,c){var d=this.tbl[a];if(d instanceof e.Tuple){var f=d.indexOf(b);if(f<0){if(c)return!1;throw Error("Cannot determine which object to remove.")}d.splice(f,1);var g=d.length;g==1&&(this.tbl[a]=d[0])}else{if(d===void 0){if(c)return!1;throw Error("Object not found.")}delete this.tbl[a];var f=this.index.indexOf(a);this.index.splice(f,1)}return!0},range_get:function(a,b,c){if(a>b)return[];var d=this.index,f=d.length,g=0,h=f,i=0;while(g!=h){var j=g+h>>1;d[j]<a?g=j+1:h=j}var k=g;g=k,h=f;while(g!=h){var j=g+h>>1;d[j]<b?g=j+1:h=j}var l=f<=g||b<d[g]?g-1:g,m=[];if(c)for(;k<=l;k++){var n=this.tbl[d[k]];if(n instanceof e.Tuple)for(var o=0,p=n.length;o<p;o++)0<=c.indexOf(n[o])&&m.push(n[o]);else 0<=c.indexOf(n)&&m.push(n)}else for(;k<=l;k++){var n=this.tbl[d[k]];n instanceof e.Tuple?m=m.concat(n.arrayize()):m.push(n)}return m}}}),f=classify("UniqueList",{property:{src:[],length:0},method:{push:function(a){this.src.indexOf(a)<0&&(this.src.push(a),this.length++)},unshift:function(a){this.src.indexOf(a)<0&&(this.src.unshift(a),this.length++)},pop:function(a){var b;if(a){var c=this.src.indexOf(a);if(c<0)throw Error("The item "+a+" is not found on list.");b=this.src.splice(c,1)[0]}else b=this.src.pop();return this.length--,b},shift:function(a){return a?this.pop(a):(this.length--,this.src.shift())},map:function(a){for(var b=0,c=this.length;b<c;b++)this.src[b]=a(this.src[b],b)},clear:function(){this.src=[],this.length=0}}}),g=classify("ElementBase",{property:{d:null,stage:null,parent:null,style:null,selecting:!1,children:[]},method:{init:function(a,b){this.parent=a,this.stage=a.stage,this.d=this.make_instance(a,b),this.parent_changed(),this.stage.draw(this)},make_instance:function(a,b){return null},get_style:function(a){return this.style&&this.style[a]||this.__class__.style[a]},stylize:function(a){this.d.style(this.get_style(a))},select:function(a){this.selecting||(this.selecting=!0,this.stylize("highlight"),a||this.stage.select(this))},unselect:function(a){this.selecting&&(this.stylize("base"),this.selecting=!1,a||this.stage.unselect(this))},toggle_select:function(a){this.selecting?this.unselect(a):this.select(a)},position:function(){return this.d.position()},center:function(){var a=this.d.position(),b=this.d.size();return{x:a.x+b.x/2,y:a.y+b.y/2}},size:function(){return this.d.size()},zIndex:function(){return this.d.zIndex()},change:function(a){for(var b in a)this.d[b](a[b])},add_child:function(a){return this.children.push(a),a},remove_child:function(a){this.children.splice(this.children.indexOf(a),1)},parent_changed:function(){},drag_start:function(a){},drag:function(a){},drag_end:function(a){},click:function(a){},mousedown:function(a){},mouseup:function(a){},mousemove:function(a){},mouseover:function(a){},mouseout:function(a){},drawed:function(a){var b=this,c=!1,d=null,e=!1;this.stage=a,this.d.addEvent({mousedown:function(a){c||(this.captureMouse(),c=!0,d=a,e=!1),b.mousedown(a)},mouseup:function(a){c&&(this.releaseMouse(),c=!1,d=null,e?b.drag_end(a):b.click(a),e=!1),b.mouseup(a)},mousemove:function(a){c?(e=!0,d&&(b.drag_start(d),d=null),b.drag(a)):b.mousemove(a)},mouseover:function(a){c||b.mouseover(a)},mouseout:function(a){c||b.mouseout(a)}})},unbind:function(a){var b=this.children.indexOf(a);if(b<0)return;this.children.splice(b,1)},erase:function(){this.stage.erase(this);while(this.children.length)this.children[0].erase();this.parent.unbind(this),this.parent=null},erased:function(a){this.stage=null}},after:{change:function(){for(var a=0,b=this.children.length;a<b;a++)this.children[a].parent_changed()}}}),h=classify("Pipe",{parent:g,"static":{style:{base:{fill:null,stroke:{width:3,color:new Fashion.Color("#F60")}},hover:{fill:null,stroke:{width:5,color:new Fashion.Color("#FF0")}},highlight:{fill:null,stroke:{width:5,color:new Fashion.Color("#000")}}}},property:{parents:[],options:null},method:{init:function(a,b){this.parents[0]=a,this.parents[1]=null,this.options=b,this.style=this.options.style,this.__super__().init.apply(this,arguments)},make_instance:function(a,b){var c=new Fashion.Path({points:new Fashion.PathData([]),style:this.get_style("base")});return c},reset_parent:function(a,b){this.parents[0]=a,this.parents[1]=b,this.parent_changed()},parent_changed:function(){var a=this.parents[0].center(),b=this.parents[1]&&this.parents[1].center()||{x:a.x,y:a.y},c=Math.max(this.parents[0].zIndex(),this.parents[1]&&this.parents[1].zIndex()||-Infinity);this.change({points:new Fashion.PathData([["M",a.x,a.y],["C",a.x+(b.x-a.x)/1.5,a.y,a.x+(b.x-a.x-(b.x-a.x)/1.5),b.y,b.x,b.y]]),zIndex:c})},click:function(a){this.toggle_select()},mouseover:function(a){this.selecting||this.stylize("hover")},mouseout:function(a){this.selecting||this.stylize("base")},mouseup:function(a){this.selecting||this.stylize("base")},drag_start:function(a){},drag:function(a){},drag_end:function(a){},drag_by_parent:function(a){var b=this.parents[0].center(),c=a.logicalPosition;this.change({points:new Fashion.PathData([["M",b.x,b.y],["C",b.x+(c.x-b.x)/1.5,b.y,b.x+(c.x-b.x-(c.x-b.x)/1.5),c.y,c.x,c.y]])})}},after:{erase:function(){this.parents[0]&&this.parents[0].unbind(this),this.parents[1]&&this.parents[1].unbind(this)}}}),i=classify("Point",{parent:g,"static":{points:{},snap_radius_scale:2,x_positions:e(),y_positions:e(),style:{base:{stroke:{width:1,color:new Fashion.Color("#000")},fill:new Fashion.FloodFill(new Fashion.Color("#FFF")),cursor:"pointer"},highlight:{stroke:{width:3,color:new Fashion.Color("#FF0")},fill:new Fashion.FloodFill(new Fashion.Color("#F00")),cursor:"pointer"}},last_hovering_points:[]},property:{d:null,stage:null,options:null,offset_position_drag_start:{x:0,y:0},last_pos:{x:0,y:0},current_pipe:null},method:{init:function(a,b){this.options=b,this.__super__().init.apply(this,arguments);var c=this.d.id;i.points[c]=this},make_instance:function(a,b){var c=new Fashion.Circle({position:{x:0,y:0},size:{x:this.options.radius*2,y:this.options.radius*2},style:this.get_style("base")});return c},origin_pos:function(a){var b=this.parent.position(),c=this.parent.size(),d=a.split("-");return{x:b.x+(d[0]==="left"?0:c.x),y:b.y+(d[1]==="top"?0:c.y)}},parent_changed:function(){var a=this.parent.size(),b=this.origin_pos(this.options.origin),c=this.options.offset,d={x:b.x+(Math.abs(c.x)<1?c.x*a.x:c.x)-this.options.radius,y:b.y+(Math.abs(c.y)<1?c.y*a.y:c.y)-this.options.radius};i.x_positions.replace(this.last_pos.x,this,d.x,!0),i.y_positions.replace(this.last_pos.y,this,d.y,!0),this.last_pos=d,this.change({position:d,zIndex:this.parent.zIndex()+1})},connectable_p:function(a){return a!==this&&a.parent!==this.parent&&(!this.options.connect_filter||this.options.connect_filter(a))},mouseup:function(a){this.stylize("base")},mouseover:function(a){this.stylize("highlight")},mouseout:function(a){this.stylize("base")},click:function(a){this.parent.click(a)},drag_start:function(a){this.current_pipe=new h(this,{style:this.options.pipe_style}),this.children.push(this.current_pipe),this.parent.drag_start(a),this.offset_position_drag_start=a.offsetPosition,i.last_hovering_points=[]},drag:function(a){this.current_pipe.drag_by_parent(a);var b=a.logicalPosition,c=this.options.radius*i.snap_radius_scale,d=i.last_hovering_points,e=i.x_positions.range_get(b.x-c,b.x+c);e=i.y_positions.range_get(b.y-c,b.y+c,e);for(var f=0,g=d.length;f<g;f++)d[f].stylize("base");for(var f=0,g=e.length;f<g;f++)this.connectable_p(e[f])?e[f].stylize("highlight"):(e.splice(f,1),--g,--f);i.last_hovering_points=e},drag_end:function(a){var b=i.last_hovering_points;for(var c=0,d=b.length;c<d;c++)b[c].stylize("base");if(b.length){var e=b[0];e.children.push(this.current_pipe),this.current_pipe.reset_parent(this,b[0])}else this.children.pop(),this.current_pipe.erase()}}}),j=classify("Node",{parent:g,"static":{style:{base:{stroke:null,fill:new Fashion.FloodFill(new Fashion.Color("#CCC"))},highlight:{stroke:{width:5,color:new Fashion.Color("#FC0")},fill:new Fashion.FloodFill(new Fashion.Color("#EEE"))}}},property:{offset_position_drag_start:{x:0,y:0},body:null,body_size:{x:0,y:0}},method:{init:function(a,b){this.options=b,this.style=this.options.style,this.__super__().init.apply(this,arguments)},add_point:function(a){return this.add_child(new i(this,a))},remove_point:function(a){this.remove_child(a)},make_instance:function(a,b){var c={position:b.position,size:b.size==="auto"?{x:0,y:0}:b.size};c.style=this.get_style("base"),c.corner={x:10,y:10};var d=new Fashion.Rect(c);b.zIndex&&d.zIndex(b.zIndex);if(b.body){var e=this,f=b.position,g=this.stage.elem.position(),h=$("<div/>",{id:"body_"+d.id});h.html(b.body),h.css({position:"absolute",left:g.left+f.x+(b.padding||0),top:g.top+f.y+(b.padding||0)}),$(document.body).append(h);var i=h.width(),j=h.height();d.size({x:i+b.padding*2,y:j+b.padding*2}),this.body=h,this.body_size={x:i,y:j},this.body.mouseup(function(a){e.body_mouseup(a)})}return d},click:function(a){this.toggle_select()},drag_start:function(a){this.select(),this.offset_position_drag_start=a.offsetPosition},drag:function(a){var b=this.stage.viewport(),d=this.size(),e=a.logicalPosition,f=this.offset_position_drag_start;this.change({position:{x:c(e.x-f.x,b.x-d.x,0),y:c(e.y-f.y,b.y-d.y,0)}})},body_changed:function(a){var b=a?a.x:this.body.width(),c=a?a.y:this.body.height();this.change({size:{x:b+this.options.padding*2,y:c+this.options.padding*2}}),this.body_size.x=b,this.body_size.y=c},body_mouseup:function(a){var b=this.body_size,c=this.body.width(),d=this.body.height();(b.x!=c||b.y!=d)&&this.body_changed({x:c,y:d})},mouseover:function(a){this.selecting||this.stylize("hover")},mouseout:function(a){this.selecting||this.stylize("base")},mouseup:function(a){this.selecting||this.stylize("base")}},after:{change:function(a){if(a.position){var b=a.position,c=this.stage.elem.position();this.body.css({left:c.left+b.x+(this.options.padding||0),top:c.top+b.y+(this.options.padding||0)})}},erase:function(){this.body.remove()}}}),k=classify("Stage",{property:{elem:null,d:null,shift_key:!1,size:{},selected_nodes:null,nodes:[]},method:{init:function(a){var b=this;this.elem=$(a),this.elem.attr({tabindex:0}),this.elem.css({outline:"none"}),this.elem.keydown(function(a){return b.keydown(a),!1}),this.elem.keyup(function(a){return b.keyup(a),!1}),this.d=new Fashion.Drawable(this.elem[0]),this.size={x:this.elem.width(),y:this.elem.height()},this.draw_background(),this.d.addEvent({mouseup:function(a){b.shift_key||b.unselect_all()}}),this.selected_nodes=new f},draw:function(a){this.d.draw(a.d),this.nodes.push(a),a.drawed(this)},erase:function(a){this.d.erase(a.d);var b=this.nodes.indexOf(a);-1<b&&this.nodes.splice(b,1),a.erased(this)},select_all:function(){for(var a=0,b=this.nodes.lenght;a<b;a++)this.nodes[a].select()},select:function(a){this.shift_key||this.unselect_all(),this.selected_nodes.push(a),a.change({zIndex:this.d.getMaxDepth()+1})},unselect:function(a){this.selected_nodes.pop(a)},unselect_all:function(){var a=this.selected_nodes;a.map(function(a,b){a.unselect(!0)}),a.clear()},viewport:function(){return this.d.viewportSize()},keydown:function(a){var b=a.keyCode;switch(b){case 8:var c=this.selected_nodes;c.map(function(a,b){a.unselect(!0),a.erase()}),c.clear();break;case 16:this.shift_key=!0}},keyup:function(a){var b=a.keyCode;switch(b){case 16:this.shift_key=!1}},draw_background:function(){var a=20,b=this.size,c=new Fashion.Color("#000"),d=.5,e=[1,4];for(var f=a;f<b.x;f+=a)this.d.draw(new Fashion.Path({points:new Fashion.PathData([["M",f,-0.5],["L",f,b.y]]),style:{fill:null,stroke:{width:d,color:c,pattern:e}}}));for(var g=a;g<b.y;g+=a)this.d.draw(new Fashion.Path({points:new Fashion.PathData([["M",-0.5,g],["L",b.x,g]]),style:{fill:null,stroke:{width:d,color:c,pattern:e}}}))}}});b.Pipe=h,b.Point=i,b.Node=j,b.Stage=k;var m={};b.definePipeType=function(a){function b(a){return a?{fill:null,stroke:a}:null}for(var c in a){var d=a[c],e=l(d.style);e.base=b(e.base),e.hover=b(e.hover)||e.base,e.highlight=b(e.highlight)||e.base,m[c]={style:e}}};var n={};b.definePointType=function(a){for(var b in a){var c=a[b];n[b]=c}};var o={};b.defineNodeType=function(a){function b(a){return a?{fill:a.fill?a.fill:null,stroke:a.stroke?a.stroke:null}:null}for(var c in a)(function(c){var d=a[c],e={},f=l(d.style);f.base=b(f.base),f.hover=b(f.hover)||f.base,f.highlight=b(f.highlight)||f.base,e.style=f,d.body?e.body=d.body:d.body_url?$.ajax({url:d.body_url,type:"get"}).done(function(a){e.body=a}):e.body="",e.points=d.points,o[c]=e})(c)},b.createPoint=function(a,b,c){var d=n[b],e=c&&c.position&&c.position.origin||"left-top",f=c&&c.position&&c.position.offset||{x:10,y:10},g=4,h=m[d.pipe].style,i=function(a){return-1<d.connectable.indexOf(a.options.type)};a.add_point({origin:e,offset:f,radius:g,pipe_style:h,connect_filter:i,type:b})},b.createNode=function(a,c,d){var e=a.viewport(),f=o[c],g=new b.Node({stage:a,unbind:function(a){}},{position:d&&d.position||{x:e.x/2-50,y:e.y/2-50},size:d&&d.size||"auto",zIndex:a.d.getMaxDepth()+1,body:f.body,padding:20,style:f.style});for(var h=0,i=f.points.length;h<i;h++){var j=f.points[h];b.createPoint(g,j.type,j)}},a.NetUI=b})(this);