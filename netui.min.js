(function(window){function _map(a,b){if(typeof b.map=="function")return b.map(a);for(var c=0,d=b.length,e=[];c<d;c++){var f=a(b[c],c);e.push(f)}return e}function _clip(a,b,c){return a<c?c:b<a?b:a}function _fashion_color(a){return a instanceof Fashion.Color?a:typeof a=="string"?new Fashion.Color(a):null}function _fashion_fill(a){return a instanceof Fashion.FloodFill?a:(a=_fashion_color(a))?new Fashion.FloodFill(a):null}function _convert_fashion(a){if(typeof a!="object"||a.constructor!=Object)return a;var b={};for(var c in a)c==="color"?b[c]=_fashion_color(a[c]):c==="fill"?b[c]=_fashion_fill(a[c]):b[c]=_convert_fashion(a[c]);return b}classify.addDirective("accessor",function(a,b,c){return a.property["_"+b]=c,a.method[b]=function(a){return 0<arguments.length&&(this["_"+b]=a),this["_"+b]},a}),function(){function a(b,c){return b?b.prototype[c]||a(b.__proto__,c):null}classify.addDirective("after",function(b,c,d){var e=b.method[c]||a(b.parent,c);if(!e)throw Error('Declaration Error: after "'+c+'" is given but the target method not found.');return b.method[c]=function(){var a=e.apply(this,arguments);return d.apply(this,arguments),a},b}),classify.addDirective("before",function(b,c,d){var e=b.method[c]||a(b.parent,c);if(!e)throw Error('Declaration Error: before "'+c+'" is given but the target method not found.');return b.method[c]=function(){d.apply(this,arguments);var a=e.apply(this,arguments);return a},b})}();var SortedList=classify("SortedList",{"static":{Tuple:classify("SortedList_Tuple",{parent:Array,method:{arrayize:function(){return Array.prototype.slice.call(this)}}})},property:{index:[],tbl:{}},method:{init:function(){},put:function(a,b){var c=this.index,d=this.tbl[a];if(d===void 0){this.tbl[a]=b;var e=0,f=c.length;while(e!=f){var g=e+f>>1;c[g]<a?e=g+1:f=g}c.splice(e,0,a)}else if(d!==b)if(d instanceof SortedList.Tuple)d.push(b);else{var h=SortedList.Tuple();h.push(d),h.push(b),this.tbl[a]=h}},get:function(a){var b=this.tbl[a];return b instanceof SortedList.Tuple&&(b=b.arrayize()),b},replace:function(a,b,c,d){var e=this.remove(a,b,!0);(e||d)&&this.put(c,b)},remove:function(a,b,c){var d=this.tbl[a];if(d instanceof SortedList.Tuple){var e=d.indexOf(b);if(e<0){if(c)return!1;throw Error("Cannot determine which object to remove.")}d.splice(e,1);var f=d.length;f==1&&(this.tbl[a]=d[0])}else{if(d===void 0){if(c)return!1;throw Error("Object not found.")}delete this.tbl[a];var e=this.index.indexOf(a);this.index.splice(e,1)}return!0},range_get:function(a,b,c){if(a>b)return[];var d=this.index,e=d.length,f=0,g=e,h=0;while(f!=g){var i=f+g>>1;d[i]<a?f=i+1:g=i}var j=f;f=j,g=e;while(f!=g){var i=f+g>>1;d[i]<b?f=i+1:g=i}var k=e<=f||b<d[f]?f-1:f,l=[];if(c)for(;j<=k;j++){var m=this.tbl[d[j]];if(m instanceof SortedList.Tuple)for(var n=0,o=m.length;n<o;n++)0<=c.indexOf(m[n])&&l.push(m[n]);else 0<=c.indexOf(m)&&l.push(m)}else for(;j<=k;j++){var m=this.tbl[d[j]];m instanceof SortedList.Tuple?l=l.concat(m.arrayize()):l.push(m)}return l}}}),UniqueList=classify("UniqueList",{property:{src:[],length:0},method:{push:function(a){this.src.indexOf(a)<0&&(this.src.push(a),this.length++)},unshift:function(a){this.src.indexOf(a)<0&&(this.src.unshift(a),this.length++)},pop:function(a){var b;if(a){var c=this.src.indexOf(a);if(c<0)throw Error("The item "+a+" is not found on list.");b=this.src.splice(c,1)[0]}else b=this.src.pop();return this.length--,b},shift:function(a){return a?this.pop(a):(this.length--,this.src.shift())},map:function(a){for(var b=0,c=this.length;b<c;b++)this.src[b]=a(this.src[b],b)},clear:function(){this.src=[],this.length=0}}}),ElementBase=classify("ElementBase",{property:{d:null,id:null,stage:null,parent:null,style:null,options:null,selecting:!1,children:[]},method:{init:function(a,b){this.parent=a,this.stage=a.stage,this.options=b||{},this.style=b&&b.style||{},this.d=this.make_instance(a,b),this.parent_changed(),this.stage.draw(this),this.id=this.d.id},make_instance:function(a,b){return null},get_style:function(a){return this.style&&this.style[a]||this.__class__.style[a]},stylize:function(a){this.d.style(this.get_style(a))},select:function(a,b){this.selecting||(this.selecting=!0,this.stylize("highlight"),a||this.stage.select(this,b))},unselect:function(a){this.selecting&&(this.stylize("base"),this.selecting=!1,a||this.stage.unselect(this))},toggle_select:function(a){this.selecting?this.unselect(a):this.select(a)},position:function(){return this.d.position()},center:function(){var a=this.d.position(),b=this.d.size();return{x:a.x+b.x/2,y:a.y+b.y/2}},size:function(){return this.d.size()},zIndex:function(){return this.d.zIndex()},change:function(a){for(var b in a)this.d[b](a[b])},add_child:function(a){return this.children.push(a),a},remove_child:function(a){this.children.splice(this.children.indexOf(a),1)},parent_changed:function(){},drag_start:function(a){},drag:function(a){},drag_end:function(a){},click:function(a){},mousedown:function(a){},mouseup:function(a){},mousemove:function(a){},mouseover:function(a){},mouseout:function(a){},drawed:function(a){var b=this,c=!1,d=null,e=!1;this.stage=a,this.d.addEvent({mousedown:function(a){c||(this.captureMouse(),c=!0,d=a,e=!1),b.mousedown(a)},mouseup:function(a){c&&(this.releaseMouse(),c=!1,d=null,e?b.drag_end(a):b.click(a),e=!1),b.mouseup(a)},mousemove:function(a){c?(e=!0,d&&(b.drag_start(d),d=null),b.drag(a)):b.mousemove(a)},mouseover:function(a){c||b.mouseover(a)},mouseout:function(a){c||b.mouseout(a)}})},unbind:function(a){var b=this.children.indexOf(a);if(b<0)return;this.children.splice(b,1)},erase:function(){this.stage.erase(this);while(this.children.length)this.children[0].erase();this.parent.unbind(this),this.parent=null},erased:function(a){this.stage=null}},after:{change:function(){for(var a=0,b=this.children.length;a<b;a++)this.children[a].parent_changed()}}}),Text=classify("Text",{parent:ElementBase,property:{},"static":{style:{color:_fashion_color("#000"),fontFamily:"Arial",fontSize:12,offset:{x:0,y:0},opacity:{normal:255,soft:160}}},method:{init:function(){this.__super__().init.apply(this,arguments)},make_instance:function(a,b){var c;b.origin&&b.origin==="center"?c=a.center():c=a.position();var d=a.zIndex()+1,e=new Fashion.Text({anchor:b.anchor||"left",position:{x:c.x+b.offset.x,y:c.y+b.offset.y},text:b.text,zIndex:d,fontFamily:b.fontFamily||Text.style.fontFamily,fontSize:b.fontSize||Text.style.fontSize});return e.style({fill:_fashion_fill(b.color||Text.style.color)}),e},parent_changed:function(){var a;this.options.origin&&this.options.origin==="center"?a=this.parent.center():a=this.parent.position();var b=this.parent.zIndex()+1;this.d.position({x:a.x+this.options.offset.x,y:a.y+this.options.offset.y}),this.d.zIndex(b)},soften:function(a){var b=this.d.style().fill;b.color.a=a?Text.style.opacity.soft:Text.style.opacity.normal,this.d.style({fill:b})},_through_event:function(a,b,c){a&&this[a]&&(c.offsetPosition.x+=this.options.offset.x,c.offsetPosition.y+=this.options.offset.y,this[a][b](c))},click:function(a){this._through_event(this.options.through_event,"click",a)},drag_start:function(a){this._through_event(this.options.through_event,"drag_start",a)},drag:function(a){this._through_event(this.options.through_event,"drag",a)},drag_end:function(a){this._through_event(this.options.through_event,"drag_end",a)}}}),Pipe=classify("Pipe",{parent:ElementBase,"static":{style:{base:{fill:null,stroke:{width:3,color:new Fashion.Color("#F60")}},hover:{fill:null,stroke:{width:5,color:new Fashion.Color("#FF0")}},highlight:{fill:null,stroke:{width:5,color:new Fashion.Color("#000")}}}},property:{parents:[]},method:{init:function(a,b){this.parents[0]=a,this.parents[1]=null,this.__super__().init.apply(this,arguments)},make_instance:function(a,b){var c=new Fashion.Path({points:new Fashion.PathData([]),style:this.get_style("base")});return c},reset_parent:function(a,b){this.parents[0]=a,this.parents[1]=b,this.parent_changed()},parent_changed:function(){var a=this.parents[0].center(),b=this.parents[1]&&this.parents[1].center()||{x:a.x,y:a.y},c=Math.max(this.parents[0].zIndex(),this.parents[1]&&this.parents[1].zIndex()||-Infinity);this.change({points:new Fashion.PathData([["M",a.x,a.y],["C",a.x+(b.x-a.x)/1.5,a.y,a.x+(b.x-a.x-(b.x-a.x)/1.5),b.y,b.x,b.y]]),zIndex:c})},click:function(a){this.toggle_select()},mouseover:function(a){this.selecting||this.stylize("hover")},mouseout:function(a){this.selecting||this.stylize("base")},mouseup:function(a){this.selecting||this.stylize("base")},drag_start:function(a){},drag:function(a){},drag_end:function(a){},drag_by_parent:function(a){var b=this.parents[0].center(),c=a.logicalPosition;this.change({points:new Fashion.PathData([["M",b.x,b.y],["C",b.x+(c.x-b.x)/1.5,b.y,b.x+(c.x-b.x-(c.x-b.x)/1.5),c.y,c.x,c.y]])})}},after:{erase:function(){this.parents[0]&&this.parents[0].unbind(this),this.parents[1]&&this.parents[1].unbind(this)}}}),Point=classify("Point",{parent:ElementBase,"static":{points:{},snap_radius_scale:2,x_positions:SortedList(),y_positions:SortedList(),style:{base:{stroke:{width:1,color:_fashion_color("#000")},fill:_fashion_fill("#FFF"),cursor:"pointer"},highlight:{stroke:{width:3,color:_fashion_color("#FF0")},fill:_fashion_fill("#F00"),cursor:"pointer"},color:_fashion_color("#000")},last_hovering_points:[],fontSize:13,fontFamily:"Arial"},accessor:{offset:{x:0,y:0}},property:{d:null,stage:null,options:null,offset_position_drag_start:{x:0,y:0},last_pos:{x:0,y:0},current_pipe:null,text:null,name:""},method:{init:function(a,b,c){this.name=c,this.offset({x:b.position.offset.x,y:b.position.offset.y}),this.__super__().init.apply(this,arguments),Point.points[this.id]=this},make_instance:function(a,b){var c=new Fashion.Circle({position:{x:0,y:0},size:{x:this.options.radius*2,y:this.options.radius*2},style:this.get_style("base")});return c},origin_pos:function(a){var b=this.parent.position(),c=this.parent.size(),d=a.split("-");return{x:b.x+(d[0]==="left"?0:c.x),y:b.y+(d[1]==="top"?Node.header.height:c.y)}},parent_changed:function(){var a=this.parent.size(),b=this.origin_pos(this.options.position.origin),c=this.offset(),d={x:b.x+(Math.abs(c.x)<1?c.x*a.x:c.x)-this.options.radius,y:b.y+(Math.abs(c.y)<1?c.y*(a.y-Node.header.height):c.y)-this.options.radius};Point.x_positions.replace(this.last_pos.x,this,d.x,!0),Point.y_positions.replace(this.last_pos.y,this,d.y,!0),this.last_pos=d,this.change({position:d,zIndex:this.parent.zIndex()+1})},connectable_p:function(a){return a!==this&&a.parent!==this.parent&&(!this.options.connect_filter||this.options.connect_filter(a))},mouseup:function(a){this.stylize("base")},mouseover:function(a){this.stylize("highlight")},mouseout:function(a){this.stylize("base")},click:function(a){this.parent.click(a)},drag_start:function(a){this.current_pipe=new Pipe(this,{style:this.options.pipe_style}),this.children.push(this.current_pipe),this.parent.drag_start(a),this.offset_position_drag_start=a.offsetPosition,Point.last_hovering_points=[]},drag:function(a){this.current_pipe.drag_by_parent(a);var b=a.logicalPosition,c=this.options.radius*Point.snap_radius_scale,d=Point.last_hovering_points,e=Point.x_positions.range_get(b.x-c,b.x+c);e=Point.y_positions.range_get(b.y-c,b.y+c,e);for(var f=0,g=d.length;f<g;f++)d[f].stylize("base");for(var f=0,g=e.length;f<g;f++)this.connectable_p(e[f])?e[f].stylize("highlight"):(e.splice(f,1),--g,--f);Point.last_hovering_points=e},drag_end:function(a){var b=Point.last_hovering_points;for(var c=0,d=b.length;c<d;c++)b[c].stylize("base");if(b.length){var e=b[0];this.connect(e,this.current_pipe)}else this.children.pop(),this.current_pipe.erase()},connect:function(a,b){a.children.push(b),b.reset_parent(this,a)},connecting_points:function(){var a=[];for(var b=0,c=this.children.length;b<c;b++){var d=this.children[b];if(d instanceof Pipe)for(var e=0;e<2;e++){var f=d.parents[e];f&&f!==this&&a.push(f)}}return a},dump_data_network:function(a){var b=this.dump(a);return{type:b.type,connections:b.connections}},dump:function(a){var b=[],c=this.connecting_points(),d=this.stage.get_elem_index(this.parent,NetUI.Node);for(var e=0,f=c.length;e<f;e++){var g=c[e],h=this.stage.get_elem_index(g.parent,NetUI.Node);(a||h<d)&&b.push([h,g.name])}var i=typeof this.options.color=="string"?this.options.color:void 0;return{label:!!this.options.label,type:this.options.type,position:{origin:this.options.position.origin,offset:this.offset()},connections:b,color:i}},on_parent_select:function(){this.text&&this.text.soften(!1)},on_parent_unselect:function(){this.text&&this.text.soften(!0)},_get_labels_anchor_position:function(){var a=this.parent.position(),b=this.parent.size(),c=this.center(),d={x:(c.x-a.x)/b.x,y:(c.y-(a.y+Node.header.height))/(b.y-Node.header.height)},e,f,g=.2,h=.3;return d.x<g?(e="left",f={x:8,y:3.5}):1-g<d.x?(e="right",f={x:-7,y:3.5}):d.y<h?(e="center",f={x:0,y:18}):1-h<d.y?(e="center",f={x:0,y:-10}):(e="left",f={x:8,y:3.5}),{anchor:e,offset:f}}},before:{drawed:function(){if(this.options.label){var a=this._get_labels_anchor_position(),b=new Text(this,{origin:"center",anchor:a.anchor,offset:{x:a.offset.x,y:a.offset.y},text:this.name,fontFamily:Point.fontFamily,fontSize:Point.fontSize,color:this.options.color});this.text=b,this.children.push(b)}}},after:{init:function(a,b,c){var d=b.connections;if(d)for(var e=0,f=d.length;e<f;e++){var g=d[e],h=g[0],c=g[1],i=this.stage.get_elem_by_index(h,NetUI.Node),j=i.get_point_by_name(c),k=new Pipe(this,{style:this.options.pipe_style});this.children.push(k),this.connect(j,k)}}}}),Button=classify("Button",{parent:ElementBase,property:{},"static":{style:{color:{base:_fashion_fill("#999"),foreground:_fashion_fill("#CCC")}},size:{x:16,y:16},icons:{},new_button:function(a,b){this.icons[a]=b}},method:{init:function(){this.__super__().init.apply(this,arguments)},make_instance:function(a,b){var c=Button.icons[b.name];if(!c)throw Error("Unknown button's name \""+b.name+'".');var d={points:new Fashion.PathData([["M",0,0],["L",Button.size.x,0],["L",Button.size.x,Button.size.y],["L",0,Button.size.y],["Z"]]),style:{stroke:null,fill:new Fashion.ImageTileFill(new Fashion.ImageData(c))}},e=new Fashion.Path(d);return b.zIndex&&e.zIndex(b.zIndex),e},origin_pos:function(a){var b=this.parent.position(),c=this.parent.size(),d=a.split("-");return{x:b.x+(d[0]==="left"?0:c.x),y:b.y+(d[1]==="top"?0:c.y)}},parent_changed:function(){var a=this.parent.size(),b=this.origin_pos(this.options.origin),c=this.options.offset;this.d.position({x:b.x+(Math.abs(c.x)<1?c.x*a.x:c.x),y:b.y+(Math.abs(c.y)<1?c.y*a.y:c.y)});var d=this.parent.zIndex()+1;this.d.zIndex(d)},click:function(a){this.options.onclick&&this.options.onclick(this.parent,a)}}}),Node=classify("Node",{parent:ElementBase,"static":{style:{base:{stroke:null,fill:_fashion_fill("#CCC")},highlight:{stroke:{width:5,color:_fashion_color("#FC0")},fill:_fashion_fill("#EEE")},color:_fashion_color("#000")},header:{height:25,fontFamily:"Arial",fontSize:16,offset:{x:18,y:18}},padding:15},accessor:{datas:{}},property:{offset_position_drag_start:{x:0,y:0},body:null,body_size:{x:0,y:0},points:{},points_length:0},method:{init:function(){this.__super__().init.apply(this,arguments),this.body.attr({id:"node_"+this.id}),this.options.onload&&this.options.onload.call(this,this)},add_point:function(a,b){var c=new Point(this,b,a);return this.points[a]=c,this.points_length++,this.add_child(c)},remove_point:function(a){var b=a.name;b&&(delete this.points[b],this.points_length--),this.remove_child(a)},get_point_by_name:function(a){return this.points[a]},make_instance:function(a,b){var c={position:b.position,size:b.size==="auto"?{x:0,y:0}:b.size};c.style=this.get_style("base"),c.corner={x:10,y:10};var d=b.type,e=new Fashion.Rect(c);return b.zIndex&&e.zIndex(b.zIndex),b.body&&this.make_body(a,e,b),e},make_body:function(a,b,c){var d=this,e=c.position,f=this.stage.html.position(),g=$("<div/>");g.html(c.body),g.css({position:"absolute",left:f.left+e.x+Node.padding,top:f.top+e.y+Node.header.height+Node.padding}),$(document.body).append(g);var h=g.width(),i=g.height();b.size({x:h+Node.padding*2,y:i+Node.header.height+Node.padding*2}),this.body=g,this.body.hide(),this.body_size={x:h,y:i},this.body.mouseup(function(a){d.body_mouseup(a)}),c.datas&&(this.datas(c.datas),this.load_datas())},body_append:function(a,b){if(!a&&!b)return;b?$(a,this.body).append(b):this.body.append(a),this.body_changed()},click:function(a){this.toggle_select()},drag_start:function(a){this.select(),this.offset_position_drag_start=a.offsetPosition},drag:function(a){var b=this.stage.viewport(),c=this.size(),d=a.logicalPosition,e=this.offset_position_drag_start;this.change({position:{x:_clip(d.x-e.x,b.x-c.x,0),y:_clip(d.y-e.y,b.y-c.y,0)}})},body_changed:function(a){var b=a?a.x:this.body.width(),c=a?a.y:this.body.height();this.change({size:{x:b+Node.padding*2,y:c+Node.header.height+Node.padding*2}}),this.body_size.x=b,this.body_size.y=c},body_mouseup:function(a){var b=this.body_size,c=this.body.width(),d=this.body.height();(b.x!=c||b.y!=d)&&this.body_changed({x:c,y:d})},mouseover:function(a){this.selecting||this.stylize("hover")},mouseout:function(a){this.selecting||this.stylize("base")},mouseup:function(a){this.selecting||this.stylize("base")},draw_buttons:function(){var a=1;for(var b in this.options.buttons){var c=this.options.buttons[b],d=new Button(this,{name:b,origin:"right-top",offset:{x:-20*a,y:5},onclick:c});this.children.push(d),a++}},load_datas:function(a){a||(a=this.datas());for(var b in a){var c=a[b],d=$("#"+b,this.body),e=d.attr("type");e==="checkbox"||e==="radio"?d.attr("checked",!!c):d.val(c)}},dump_datas:function(){var a={},b=this.datas();if(b)for(var c in b){var d=$("#"+c,this.body),e=d.attr("type");e==="checkbox"||e==="radio"?a[c]=!!d.is(":checked"):a[c]=d.val()}return a},dump_points:function(a){var b={};for(var c in this.points){var d=this.points[c];b[c]=d.dump(a)}return b},dump_data_network_points:function(a){var b={};for(var c in this.points){var d=this.points[c];b[c]=d.dump_data_network(a)}return b},dump_data_network:function(){var a=this.dump_data_network_points(!0),b=this.dump_datas();return{type:this.options.type,points:a,datas:b}},dump:function(){var a=this.dump_points(!1),b=this.dump_datas(),c=this.body.html();return{selecting:this.selecting,type:this.options.type,position:this.position(),size:this.options.size,zIndex:this.zIndex(),points:a,datas:b,body:c!==NetUI.types.node[this.options.type].body?c:void 0}}},before:{drawed:function(){var a=new Text(this,{text:this.options.type,color:this.options.color||Node.style.color,offset:{x:Node.header.offset.x,y:Node.header.offset.y},fontFamily:Node.header.fontFamily,fontSize:Node.header.fontSize,through_event:"parent"});this.children.push(a),this.options.buttons&&this.draw_buttons()},erase:function(){this.body.remove()}},after:{change:function(a){if(a.position){var b=a.position,c=this.stage.html.position();this.body.css({left:c.left+b.x+Node.padding,top:c.top+b.y+Node.header.height+Node.padding})}},select:function(){this.body.hide();for(var a in this.points)this.points[a].on_parent_select()},unselect:function(){this.body.show();for(var a in this.points)this.points[a].on_parent_unselect()}}}),Stage=classify("Stage",{property:{elem:null,d:null,shift_key:!1,size:{},selected_elems:null,elems:[]},method:{init:function(a){var b=this;this.html=$(a),this.html.attr({tabindex:0}),this.html.css({outline:"none"}),this.html.keydown(function(a){return b.keydown(a),!1}),this.html.keyup(function(a){return b.keyup(a),!1}),this.d=new Fashion.Drawable(this.html[0]),this.size={x:this.html.width(),y:this.html.height()},this.draw_background(),this.d.addEvent({mouseup:function(a){b.shift_key||b.unselect_all()}}),this.selected_elems=new UniqueList},hide:function(){this.html.hide();for(var a=this.elems.length-1;-1<a;a--)this.elems[a].body&&this.elems[a].body.hide()},show:function(){this.html.show();for(var a=this.elems.length-1;-1<a;a--)this.elems[a].body&&this.elems[a].body.show()},draw:function(a){this.d.draw(a.d),this.elems.push(a),a.drawed(this)},erase:function(a){this.d.erase(a.d);var b=this.elems.indexOf(a);-1<b&&this.elems.splice(b,1),a.erased(this)},clear:function(){this.unselect_all();while(this.elems.length)this.elems[0].erase()},get_elem_index:function(a,b){var c=0;if(b){for(var d=0,e=this.elems.length;d<e;d++){var f=this.elems[d];if(f===a)break;f instanceof b&&c++}d==e&&(c=-1)}else c=this.elems.indexOf(a);return c},get_elem_by_index:function(a,b){var c=0;if(!b)return this.elems[a];for(var d=0,e=this.elems.length;d<e;d++){var f=this.elems[d];if(f instanceof b){if(c===a)return f;c++}}return null},select_all:function(){for(var a=0,b=this.elems.length;a<b;a++)this.elems[a].select(!0),this.selected_elems.push(this.elems[a])},select:function(a,b){!this.shift_key&&!b&&this.unselect_all(),this.selected_elems.push(a),a.change({zIndex:this.d.getMaxDepth()+1})},unselect:function(a){this.selected_elems.pop(a)},unselect_all:function(){var a=this.selected_elems;a.map(function(a,b){a.unselect(!0)}),a.clear()},viewport:function(){return this.d.viewportSize()},keydown:function(a){var b=a.keyCode;switch(b){case 8:var c=this.selected_elems;c.map(function(a,b){a.unselect(!0),a.erase()}),c.clear();break;case 16:this.shift_key=!0}},keyup:function(a){var b=a.keyCode;switch(b){case 16:this.shift_key=!1}},draw_background:function(){var a=20,b=this.size,c=_fashion_color("#FFF"),d=.5,e=[1,4];for(var f=a;f<b.x;f+=a)this.d.draw(new Fashion.Path({points:new Fashion.PathData([["M",f,-0.5],["L",f,b.y]]),style:{fill:null,stroke:{width:d,color:c,pattern:e}}}));for(var g=a;g<b.y;g+=a)this.d.draw(new Fashion.Path({points:new Fashion.PathData([["M",-0.5,g],["L",b.x,g]]),style:{fill:null,stroke:{width:d,color:c,pattern:e}}}))}}}),NetUI=classify("NetUI",{"static":{Pipe:Pipe,Point:Point,Node:Node,Stage:Stage,Button:Button,types:{pipe:{},point:{},node:{}},type_definitions:{pipe:{},point:{},node:{}},all_defined:!0,defineNodeTypeAccm:0,after_defineds:[],definePipeType:function(a){function b(a){return a?{fill:null,stroke:a}:null}for(var c in a){var d=a[c];this.type_definitions.pipe[c]=d;var e=_convert_fashion(d.style);e.base=b(e.base),e.hover=b(e.hover)||e.base,e.highlight=b(e.highlight)||e.base,this.types.pipe[c]={style:e}}},definePointType:function(a){for(var b in a){var c=a[b];this.type_definitions.point[b]=c,this.types.point[b]=_convert_fashion(c)}},defineNodeType:function(a,b){function d(){b&&b(),c.defineNodeTypeAccm-=1,c.defineNodeTypeAccm==0&&c.fireAllDefined()}function e(a){g.splice(g.indexOf(a),1),g.length==0&&d()}function f(a){return a?{fill:a.fill?a.fill:null,stroke:a.stroke?a.stroke:null}:null}var c=this;c.all_defined=!1,c.defineNodeTypeAccm+=1;var g=[];for(var h in a)(function(b){g.push(b);var d=a[b];if(d.buttons)for(var h in d.buttons){var i=d.buttons[h];d.buttons[h]=i+""}d.onload&&(d.onload=d.onload+""),c.type_definitions.node[b]=d;var j={},k=_convert_fashion(d.style);k.base=f(k.base),k.hover=f(k.hover)||k.base,k.highlight=f(k.highlight)||k.base,j.style=k,d.body?j.body=d.body:d.body_url?$.ajax({url:d.body_url,type:"get"}).done(function(a){j.body=a,e(b)}):j.body="",j.points=d.points,j.data_binds=d.data_binds,j.buttons=d.buttons,j.onload=d.onload,c.types.node[b]=j})(h)},defineButton:function(a,b){Button.new_button(a,b)},fireAllDefined:function(){this.all_defined=!0;var a;while(a=this.after_defineds.shift())a()},setOnDefinedAll:function(a){this.all_defined?a():this.after_defineds.push(a)},createPoint:function(a,b,c,d){var e=d,f=this.types.point[c],g=e&&e.position&&e.position.origin||"left-top",h=e&&e.position&&e.position.offset||{x:10,y:10},i=4,j=this.types.pipe[f.pipe].style,k=function(a){return-1<f.connectable.indexOf(a.options.type)},l=e&&e.hasOwnProperty("label")?e.label:f.label;a.add_point(b,{position:{origin:g,offset:h},radius:i,pipe_style:j,connect_filter:k,connections:e.connections||[],type:c,label:l,color:e&&e.color||f.color})},createNode:function(stage,type,definition){var d=definition,vp=stage.viewport(),settings=this.types.node[type],datas={};for(var k in settings.data_binds)datas[k]=settings.data_binds[k];if(d&&d.datas)for(var k in d.datas)datas[k]=d.datas[k];var buttons={};for(var k in settings.buttons){var fn_str=settings.buttons[k];buttons[k]=eval("("+fn_str+")")}var onload=function(){};settings.onload&&(onload=eval("("+settings.onload+")"));var node=new this.Node({stage:stage,unbind:function(a){}},{position:d&&d.position||{x:vp.x/2-50,y:vp.y/2-50},size:d&&d.size||"auto",zIndex:d&&d.zIndex||stage.d.getMaxDepth()+1,body:d&&d.body&&$(d.body)||settings.body,datas:datas,padding:25,style:settings.style,type:type,color:d&&d.color||d&&d.style&&d.style.color||settings.style&&settings.style.color||settings.color,buttons:buttons,onload:onload});if(d&&d.points)for(var name in d.points){var p=d.points[name];this.createPoint(node,name,p.type,p)}else for(var name in settings.points){var p=settings.points[name];this.createPoint(node,name,p.type,p)}d&&d.selecting?node.select(!1,!0):node.unselect(!1,!0)},dump_data_network:function(a,b){for(var c=0,d=a.elems.length,e=[];c<d;c++){var f=a.elems[c];f instanceof Node&&e.push(f.dump_data_network())}return b?JSON.stringify(e,null,b):JSON.stringify(e)},dump:function(a,b){for(var c=0,d=a.elems.length,e=[];c<d;c++){var f=a.elems[c];f instanceof Node&&e.push(f.dump())}var g={nodes:e,types:this.type_definitions};return b?JSON.stringify(g,null,b):JSON.stringify(g)},load:function(a,b,c,d){function e(){if(a){var c=b.types;for(var d in c){var e=c[d];switch(d){case"pipe":NetUI.definePipeType(e);break;case"point":NetUI.definePointType(e);break;case"node":NetUI.defineNodeType(e,f)}}}}function f(){var c=b.nodes;for(var d=0,e=c.length;d<e;d++){var f=c[d];NetUI.createNode(a,f.type,{position:f.position,size:f.size,zIndex:f.zIndex,selecting:f.selecting,points:f.points,datas:f.datas,body:f.body})}}c&&(a.clear(),d||(this.type_definitions={pipe:{},point:{},node:{}}));var b=JSON.parse(b);d?f():e()}}});window.NetUI=NetUI})(this);